import{_ as E}from"./eA2H0pyo.js";import{_ as x}from"./Bf0aH3QM.js";import{u as U}from"./il7jLVcv.js";import{_ as $,a as B,b as F}from"./BMzqleIn.js";import{d as N,j as q,G as D,u as P,o as _,E as S,c as A,b as C,e as l,f as d,g as V,l as n}from"./DSPXqrpM.js";import{u as j}from"./BxMKpl0t.js";import{u as R}from"./CnpgD76R.js";import"./WCtLych_.js";import"./Bcsf2iPY.js";import"./f4feb2ck.js";const k={class:"min-h-screen bg-gray-50 p-5"},H={class:"mx-auto"},I={class:"bg-white rounded-lg border border-gray-100 overflow-hidden"},L={class:"p-6"},M={class:"space-y-8"},G={class:"flex justify-end mt-6"},ae=N({__name:"update",setup(O){j({title:"Update Test Panel | Malawi Test Catalog"});const c=q(),f=D(),{$toast:r,$metadata:u}=P(),{canEdit:y}=R();y.value||(r.error("You don't have permission to edit test panels"),c.push("/app/test-panels"));const m=t=>{t.detail&&t.detail.description!==void 0&&(e.description=t.detail.description)};_(()=>{window.addEventListener("description-updated",m)}),S(()=>{window.removeEventListener("description-updated",m)});const{loading:i,testPanel:e,validationErrors:p,handleTestTypesUpdate:h,getValidationErrors:g,prepareDataForSubmission:b}=U(),v={fields:[{name:"name",label:"Name",rules:{required:!0}},{name:"short_name",label:"Short Name",rules:{required:!0}},{name:"description",label:"Description",rules:{required:!0}},{name:"test_types",label:"Test Types",rules:{custom:t=>!e.test_types||e.test_types.length===0?"At least one test type must be selected":!0}}]},T=async()=>{i.value=!0;try{const t=f.query.id;if(!t){r.error("Test panel ID is missing");return}const a=await u.test_panels.getById(Number(t));if(a){const s=a.test_types?a.test_types.map(o=>o.id):[];Object.assign(e,{...a,test_types:s})}}catch(t){console.error("Failed to fetch test panel:",t),r.error("Failed to fetch test panel")}finally{i.value=!1}},w=async(t,a)=>{const s=p;if(!e.description||e.description.trim()===""?(s.description={message:"Description is required"},a=!1):s.description&&delete s.description,!e.test_types||e.test_types.length===0?(s.test_types={message:"At least one test type must be selected"},a=!1):s.test_types&&delete s.test_types,!a){console.error("Form validation failed:",p);return}e.description===null&&(e.description=""),i.value=!0;try{const o=b();await u.test_panels.update(e.id,{test_panel:o})&&(r.success("Test panel updated successfully"),setTimeout(()=>{c.push("/app/test-panels")},2e3))}catch(o){console.error("Error updating test panel:",o),r.error("Failed to update test panel"),o.validation&&g(o.validation)}finally{i.value=!1}};return _(T),(t,a)=>{const s=E,o=x;return C(),A("div",k,[l("div",H,[l("div",I,[d(s,{icon:"fluent:panel-left-text-20-regular",title:"Update Test Panel",description:"Edit test panel with associated test types"}),l("div",L,[d(F,{config:v,onSubmit:w,"validate-on-submit":!0,"validate-on-change":!0,"model-value":n(e)},{default:V(()=>[l("div",M,[d($,{"test-panel":n(e),errors:n(p)},null,8,["test-panel","errors"]),d(B,{"test-panel":n(e),"onUpdate:selectedTestTypes":n(h)},null,8,["test-panel","onUpdate:selectedTestTypes"]),l("div",G,[d(o,{type:"submit",label:"Submit",loading:n(i)},null,8,["loading"])])])]),_:1},8,["model-value"])])])])])}}});export{ae as default};
