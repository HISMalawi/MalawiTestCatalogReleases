import{_ as S}from"./eA2H0pyo.js";import{_ as T}from"./WCtLych_.js";import{_ as I}from"./Cy6ejAbI.js";import{_ as D}from"./Bf0aH3QM.js";import{_ as E}from"./BgOZ5tY3.js";import{d as M,u as R,j,D as k,r as d,z as H,o as O,c as b,b as y,e as p,f as l,g as z,F as Y,A as G,t as J}from"./DSPXqrpM.js";import{u as K}from"./BxMKpl0t.js";import"./f4feb2ck.js";const Q={class:"min-h-screen bg-gray-50 p-5"},W={class:"mx-auto"},X={class:"bg-white rounded-lg border border-gray-100 overflow-hidden"},Z={class:"w-full py-5 px-5 overflow-visible"},ee={class:"w-full grid grid-cols-2 gap-5 overflow-visible"},ae={class:"col-span-2"},oe={class:"flex flex-wrap gap-2"},pe=M({__name:"profile",setup(re){K({title:"My Profile | Malawi Test Catalog"});const{$metadata:h,$toast:m,$api:V}=R(),w=j(),f=k(),c=d(!1),U=d(!1),i=d(""),u=d(null),x=d(""),L=d([]),v=d([]);let P;const e=H({username:"",app_name:"",partner:"",location:"",password:"",password_confirmation:"",id:0,created_at:"",updated_at:""}),C={fields:[{name:"username",label:"Username",rules:{required:!0,minLength:4}},{name:"app_name",label:"Full Name",rules:{required:!0}},{name:"partner",label:"Partner",rules:{required:!0}},{name:"location",label:"Location",rules:{required:!1}},{name:"password",label:"New Password",rules:{required:!1,minLength:6}},{name:"password_confirmation",label:"Confirm New Password",rules:{required:!1,minLength:6}}]},q=async()=>{var o,a;c.value=!0;try{const n=(o=f.user)==null?void 0:o.id;if(!n){m.error("Unable to load user profile"),w.push("/app");return}const t=await h.users.getById(n);if(u.value=t,x.value=t.username,L.value=((a=t.roles)==null?void 0:a.map(r=>typeof r=="string"?r:r.name))||[],u.value!==null&&(Object.keys(e).forEach(r=>{u.value&&r in u.value&&u.value[r]!==void 0&&r!=="password"&&r!=="password_confirmation"&&(e[r]=u.value[r])}),t.location)){const r=t.location.toLowerCase(),_=v.value.find(g=>g.id.toLowerCase()===r);e.location=_?_.id:t.location}}catch{m.error("Failed to fetch profile data"),setTimeout(()=>{w.push("/app")},3e3)}finally{c.value=!1}},B=()=>{clearTimeout(P),i.value="",P=setTimeout(()=>{N()},1e3)},N=async()=>{if(e.username===x.value){i.value="";return}if(!e.username||e.username.trim()===""||e.username.length<4){i.value="";return}U.value=!0,i.value="";try{await V.get(`users/check_username/${e.username}`),i.value=""}catch(o){o.status===422&&(i.value=o.data.message)}finally{U.value=!1}},A=o=>o.split("_").map(a=>a.charAt(0).toUpperCase()+a.slice(1)).join(" "),F=async()=>{try{const o=await V.get("users/locations/all");o&&Array.isArray(o)&&(v.value=o.map(a=>({id:a,label:a})))}catch(o){console.error("Error fetching locations:",o),m.error("Failed to load locations")}},$=async(o,a)=>{if(i.value){m.error("Please fix username error before submitting");return}if(!(!a||!u.value)){if(e.password&&e.password!==e.password_confirmation){m.error("Passwords do not match");return}c.value=!0;try{const n={...u.value,username:e.username,app_name:e.app_name,partner:e.partner,location:e.location};e.password&&(n.password=e.password,n.password_confirmation=e.password_confirmation),await h.users.update(n.id,n),m.success("Profile updated successfully"),f.user&&(f.user.username=e.username,f.user.app_name=e.app_name),setTimeout(()=>{w.push("/app")},2e3)}catch{m.error("An error occurred while updating profile")}finally{c.value=!1}}};return O(()=>{F(),q()}),(o,a)=>{const n=S,t=T,r=I,_=D,g=E;return y(),b("div",Q,[p("div",W,[p("div",X,[l(n,{icon:"mdi:account-circle-outline",title:"My Profile",description:"View and edit your account information"}),p("div",Z,[l(g,{config:C,onSubmit:$},{default:z(({})=>[p("div",ee,[l(t,{name:"username",label:"Username",modelValue:e.username,"onUpdate:modelValue":a[0]||(a[0]=s=>e.username=s),"error-message":i.value,required:"",onInput:B},null,8,["modelValue","error-message"]),l(t,{name:"app_name",label:"Full Name",modelValue:e.app_name,"onUpdate:modelValue":a[1]||(a[1]=s=>e.app_name=s),required:""},null,8,["modelValue"]),l(t,{name:"partner",label:"Partner",modelValue:e.partner,"onUpdate:modelValue":a[2]||(a[2]=s=>e.partner=s),required:""},null,8,["modelValue"]),l(r,{name:"location",label:"Location",options:v.value,modelValue:e.location,"onUpdate:modelValue":a[3]||(a[3]=s=>e.location=s),placeholder:"Select location"},null,8,["options","modelValue"]),p("div",ae,[a[6]||(a[6]=p("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Your Roles",-1)),p("div",oe,[(y(!0),b(Y,null,G(L.value,s=>(y(),b("span",{key:s,class:"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-emerald-100 text-emerald-800"},J(A(s)),1))),128))])]),l(t,{name:"password",label:"New Password (optional)",type:"password",modelValue:e.password,"onUpdate:modelValue":a[4]||(a[4]=s=>e.password=s)},null,8,["modelValue"]),l(t,{name:"password_confirmation",label:"Confirm New Password",type:"password",modelValue:e.password_confirmation,"onUpdate:modelValue":a[5]||(a[5]=s=>e.password_confirmation=s)},null,8,["modelValue"])]),l(_,{class:"mt-4",label:"Update Profile",loading:c.value,type:"submit"},null,8,["loading"])]),_:1})])])])])}}});export{pe as default};
